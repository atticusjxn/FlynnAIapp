# FlynnAI

FlynnAI is an AI receptionist for service businesses. It answers inbound calls, captures the information your team needs, and turns every conversation into a structured event you can action immediately. Owners pick the voice, greeting, and question flow so callers feel like they are talking to a real member of the crew.

## Features

- **Koala Concierge**: Tune your AI receptionist’s voice, greeting script, and required intake questions.
- **Call Intelligence**: Record, transcribe, and summarise every call with automatic follow-up drafts.
- **Events Timeline**: Manage upcoming work, approvals, and completions from the new Events tab.
- **Client Management**: Keep a living history of customer calls, preferences, and approvals.
- **Notifications**: Push, SMS, and email nudges to keep owners on schedule.
- **Dashboard**: Real-time pipeline overview plus recent call activity.

## Tech Stack

- **Frontend**: React Native with Expo
- **Backend**: Supabase (PostgreSQL + Auth + Storage)
- **Telephony**: Twilio Voice + Lookup APIs
- **UI Components**: React Native Paper, React Native Elements
- **Navigation**: React Navigation
- **State Management**: React Context API
- **Authentication**: Supabase Auth with email/OTP

## Setup Instructions

### Prerequisites

- Node.js (v18 or higher)
- npm or yarn
- Expo CLI
- Expo Go app on your phone for testing

### Installation

1. Clone the repository:
```bash
git clone [repository-url]
cd FlynnAI
```

2. Install dependencies:
```bash
npm install
```

3. Environment setup:
- The `.env` file is already configured with Supabase credentials
- Project URL: `https://zvfeafmmtfplzpnocyjw.supabase.co`

### Running the App

1. Start the development server:
```bash
npm start
```

2. Run on iOS:
```bash
npm run ios
```

3. Run on Android:
```bash
npm run android
```

4. Run on Web:
```bash
npm run web
```

## Core Data Model

- **users**: Business owner profiles and receptionist preferences (voice, greeting, behaviour)
- **clients**: Customer contact info and call history
- **jobs** *(Events)*: Structured requests generated by calls or manual entry
- **phone_calls**: Raw call metadata, recordings, transcripts
- **confirmations**: SMS/email follow-ups and approval logs
- **job_attachments**: Photos, documents, recordings tied to an event

## Project Structure

```
FlynnAI/
├── src/
│   ├── screens/         # App screens
│   ├── components/      # Reusable UI components
│   ├── services/        # API and Supabase integration
│   ├── navigation/      # Navigation configuration
│   ├── context/         # React Context providers
│   ├── hooks/           # Custom React hooks
│   ├── utils/           # Helper functions
│   └── types/           # TypeScript definitions
├── assets/              # Images, fonts
├── app.json            # Expo configuration
└── .env                # Environment variables
```

## Key Features Implementation

### Authentication
- Email/password authentication with OTP support
- Automatic user profile creation on signup
- Session persistence using AsyncStorage
- Server APIs verify Supabase Auth JWTs (see below)

#### API Authentication
- All `/jobs` and `/telephony/calls` routes expect `Authorization: Bearer <jwt>` signed with `SUPABASE_JWT_SECRET`.
- When `NODE_ENV=development` and no bearer token is present, the server accepts legacy `x-user-id` headers for local testing only.
- Configure the backend with:
  - `SUPABASE_JWT_SECRET` – copy from the Supabase project settings (`Settings → API → JWT Secret`).
- Example curl (JWT):
  ```bash
  curl http://localhost:3000/jobs \
    -H "Authorization: Bearer <your_supabase_jwt>"
  ```
- Example curl (development fallback):
  ```bash
  NODE_ENV=development curl http://localhost:3000/jobs \
    -H "x-user-id: 00000000-0000-0000-0000-000000000001"
  ```

### Koala Concierge Controls
- Choose from curated voice profiles or record your own
- Configure greetings and dynamic question flows
- Preview the experience with in-app call simulations

### Event Management
- Events tab replaces the old jobs list with filters for today, this week, pending, and completed items
- Event detail drawer surfaces transcripts, follow-up drafts, and customer context

### Call Intelligence
- Twilio webhook ingests calls, records audio, and requests transcription
- Parsed details feed directly into the Events timeline and client records

### Dashboard
- Real-time statistics for calls, follow-ups, and events
- One tap access to the koala concierge and client records
- Pull-to-refresh functionality

## Development Notes

- Row Level Security (RLS) is enabled on all tables
- All user data is isolated by user_id
- TypeScript types are generated from Supabase schema
- The app uses Expo SDK 54 with React Native 0.81.x
- Push notifications rely on Expo's `expo-notifications` module and device-specific tokens stored in `notification_tokens`

### Push Notifications

When an event is created or updated, the backend records the activity and attempts to notify the owner on every registered device.

**Database**
- `notification_tokens` stores per-user device tokens with strict RLS (`user_id = auth.uid()`).
- Tokens are unique per device (`token` is unique) and indexed by `user_id` for efficient lookups.

**Environment variables**
- `FCM_SERVER_KEY` – Firebase Cloud Messaging server key for Android devices.
- `APNS_KEY_ID` – Apple Push Notification key identifier.
- `APNS_TEAM_ID` – Apple Developer Team ID.
- `APNS_PRIVATE_KEY` – Contents of your `.p8` key (use `\n` escapes for newlines).
- `APNS_BUNDLE_ID` – iOS bundle identifier used for APNs topics (defaults to `com.flynnai.app`).
- `APNS_HOST` *(optional)* – Override (`https://api.sandbox.push.apple.com` vs production).
- `STRIPE_SECRET_KEY` – Server-side key used to verify payments.
- `STRIPE_WEBHOOK_SECRET` – Signing secret for the `/stripe/webhook` endpoint.
- `STRIPE_BASIC_PRICE_ID` / `STRIPE_GROWTH_PRICE_ID` – Price IDs for the $49 and $99 concierge plans.
- `EXPO_PUBLIC_STRIPE_BASIC_LINK` / `EXPO_PUBLIC_STRIPE_GROWTH_LINK` – Hosted payment links opened from the mobile paywall.

**Registering a device token**
```bash
curl -X POST "http://localhost:3000/me/notifications/token" \\
  -H "Authorization: Bearer <SUPABASE_JWT>" \\
  -H "Content-Type: application/json" \\
  -d '{"platform":"ios","token":"<device-token>"}'
```

**Triggering a notification for an event**
```bash
curl -X POST "http://localhost:3000/jobs/<job-id>/notify" \\
  -H "Authorization: Bearer <SUPABASE_JWT>"
```

### Voice Cloning

To enable custom receptionist voices, configure the following server environment variables:

- `ELEVENLABS_API_KEY` – ElevenLabs API key used for cloning.
- `ELEVENLABS_MODEL_ID` *(optional)* – model to use when cloning (defaults to `eleven_multilingual_v2`).
- `VOICE_PROFILE_BUCKET` *(optional)* – storage bucket for uploaded voice samples (defaults to `voice-profiles`).

The mobile app uploads recordings to Supabase storage; the server fetches the sample and initiates cloning with ElevenLabs. Status is tracked in the `voice_profiles` table.

### Real-time receptionist TTS

Live call audio is generated through the configured TTS provider. Azure Speech is the default when `AZURE_SPEECH_KEY` and `AZURE_SPEECH_REGION` are present.

- `AZURE_SPEECH_KEY` – primary key from the Azure Speech resource.
- `AZURE_SPEECH_REGION` – Azure region (for example `australiaeast`).
- `AZURE_SPEECH_ENDPOINT` *(optional)* – override for the generated endpoint URL.
- `AZURE_TTS_DEFAULT_VOICE` *(optional)* – fallback voice (defaults to `en-AU-NatashaNeural`).
- `AZURE_VOICE_KOALA_WARM`, `AZURE_VOICE_KOALA_EXPERT`, `AZURE_VOICE_KOALA_HYPE` *(optional)* – map receptionist presets to Azure voices.
- `TTS_PROVIDER` *(optional)* – force `azure` or `elevenlabs`; when unset the server prefers Azure when credentials exist and falls back to ElevenLabs.
- `TTS_CACHE_TTL_MS` / `TTS_CACHE_MAX_ENTRIES` *(optional)* – control in-memory audio cache duration and size.

If Azure credentials are not supplied the server falls back to ElevenLabs using existing `ELEVENLABS_*` variables. Custom voice previews remain ElevenLabs-only until Azure custom neural voices are onboarded.

Both endpoints return success/failure details; the notify endpoint reports the number of device sends attempted and delivered.

## Next Steps

- Voice marketplace with premium profiles and fine-grained tone sliders
- Animated koala avatar that lip-syncs during call previews
- Call simulation studio for QA before going live
- Deeper event automations (task checklists, templated follow-ups)
- Analytics for receptionist performance and conversion rates

## Support

For issues or questions, please contact the development team.

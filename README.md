# FlynnAI

FlynnAI is an AI receptionist for service businesses. It answers inbound calls, captures the information your team needs, and turns every conversation into a structured event you can action immediately. Owners pick the voice, greeting, and question flow so callers feel like they are talking to a real member of the crew.

## Features

- **Koala Concierge**: Tune your AI receptionist’s voice, greeting script, and required intake questions.
- **Call Intelligence**: Record, transcribe, and summarise every call with automatic follow-up drafts.
- **Events Timeline**: Manage upcoming work, approvals, and completions from the new Events tab.
- **Client Management**: Keep a living history of customer calls, preferences, and approvals.
- **Notifications**: Push, SMS, and email nudges to keep owners on schedule.
- **Dashboard**: Real-time pipeline overview plus recent call activity.

## Tech Stack

- **Frontend**: React Native with Expo
- **Backend**: Supabase (PostgreSQL + Auth + Storage)
- **Telephony**: Twilio Voice + Lookup APIs
- **UI Components**: React Native Paper, React Native Elements
- **Navigation**: React Navigation
- **State Management**: React Context API
- **Authentication**: Supabase Auth with email/OTP

## Setup Instructions

### Prerequisites

- Node.js (v18 or higher)
- npm or yarn
- Expo CLI
- Expo Go app on your phone for testing

### Installation

1. Clone the repository:
```bash
git clone [repository-url]
cd FlynnAI
```

2. Install dependencies:
```bash
npm install
```

3. Environment setup:
- The `.env` file is already configured with Supabase credentials
- Project URL: `https://zvfeafmmtfplzpnocyjw.supabase.co`

### Running the App

1. Start the development server:
```bash
npm start
```

2. Run on iOS:
```bash
npm run ios
```

3. Run on Android:
```bash
npm run android
```

4. Run on Web:
```bash
npm run web
```

## Core Data Model

- **users**: Business owner profiles and receptionist preferences (voice, greeting, behaviour)
- **clients**: Customer contact info and call history
- **jobs** *(Events)*: Structured requests generated by calls or manual entry
- **phone_calls**: Raw call metadata, recordings, transcripts
- **confirmations**: SMS/email follow-ups and approval logs
- **job_attachments**: Photos, documents, recordings tied to an event

## Project Structure

```
FlynnAI/
├── src/
│   ├── screens/         # App screens
│   ├── components/      # Reusable UI components
│   ├── services/        # API and Supabase integration
│   ├── navigation/      # Navigation configuration
│   ├── context/         # React Context providers
│   ├── hooks/           # Custom React hooks
│   ├── utils/           # Helper functions
│   └── types/           # TypeScript definitions
├── assets/              # Images, fonts
├── app.json            # Expo configuration
└── .env                # Environment variables
```

## Key Features Implementation

### Authentication
- Email/password authentication with OTP support
- Automatic user profile creation on signup
- Session persistence using AsyncStorage
- Server APIs verify Supabase Auth JWTs (see below)

#### API Authentication
- All `/jobs` and `/telephony/calls` routes expect `Authorization: Bearer <jwt>` signed with `SUPABASE_JWT_SECRET`.
- When `NODE_ENV=development` and no bearer token is present, the server accepts legacy `x-user-id` headers for local testing only.
- Configure the backend with:
  - `SUPABASE_JWT_SECRET` – copy from the Supabase project settings (`Settings → API → JWT Secret`).
- Example curl (JWT):
  ```bash
  curl http://localhost:3000/jobs \
    -H "Authorization: Bearer <your_supabase_jwt>"
  ```
- Example curl (development fallback):
  ```bash
  NODE_ENV=development curl http://localhost:3000/jobs \
    -H "x-user-id: 00000000-0000-0000-0000-000000000001"
  ```

### Koala Concierge Controls
- Choose from curated voice profiles or record your own
- Configure greetings and dynamic question flows
- Preview the experience with in-app call simulations

### Event Management
- Events tab replaces the old jobs list with filters for today, this week, pending, and completed items
- Event detail drawer surfaces transcripts, follow-up drafts, and customer context

### Call Intelligence
- Twilio webhook ingests calls, records audio, and requests transcription
- Parsed details feed directly into the Events timeline and client records

### Dashboard
- Real-time statistics for calls, follow-ups, and events
- One tap access to the koala concierge and client records
- Pull-to-refresh functionality

## Development Notes

- Row Level Security (RLS) is enabled on all tables
- All user data is isolated by user_id
- TypeScript types are generated from Supabase schema
- The app uses Expo SDK 54 with React Native 0.81.x
- Push notifications rely on Expo's `expo-notifications` module and device-specific tokens stored in `notification_tokens`

### Push Notifications

When an event is created or updated, the backend records the activity and attempts to notify the owner on every registered device.

**Database**
- `notification_tokens` stores per-user device tokens with strict RLS (`user_id = auth.uid()`).
- Tokens are unique per device (`token` is unique) and indexed by `user_id` for efficient lookups.

**Environment variables**
- `FCM_SERVER_KEY` – Firebase Cloud Messaging server key for Android devices.
- `APNS_KEY_ID` – Apple Push Notification key identifier.
- `APNS_TEAM_ID` – Apple Developer Team ID.
- `APNS_PRIVATE_KEY` – Contents of your `.p8` key (use `\n` escapes for newlines).
- `APNS_BUNDLE_ID` – iOS bundle identifier used for APNs topics (defaults to `com.flynnai.app`).
- `APNS_HOST` *(optional)* – Override (`https://api.sandbox.push.apple.com` vs production).

## Smart call routing

### Overview
Smart call routing classifies every inbound caller as a new lead, existing client, personal contact, or spam. The server evaluates the active routing mode, manual overrides, and after-hours schedule to decide whether the AI receptionist should answer or the caller should hear voicemail. Voicemail calls still store recordings and transcripts, while AI intake calls continue to create event/job cards.

### Database objects

| Table | Purpose |
| --- | --- |
| `callers` | Per-user caller directory with label (`lead`, `client`, `personal`, `spam`), optional display name, and routing override. |
| `call_routing_settings` | Routing mode (`smart_auto`, `intake`, `voicemail`), after-hours override, JSON business-hours schedule, and feature toggle. |
| `call_voicemails` | Normalised voicemail metadata linking a call SID to its stored recording and transcript. |

Canonical DDL lives in `supabase/migrations/20250118_smart_call_routing.sql`. A sample seed is available at `supabase/seeds/20250118_smart_call_routing_seed.sql`.

### Required environment variables

| Variable | Description |
| --- | --- |
| `FEATURE_SMART_CALL_ROUTING` | Set to `disabled` to turn the feature off globally. Any other value keeps it enabled. |
| `FEATURE_SMART_CALL_ROUTING_FALLBACK_MODE` | Optional fallback route (`voicemail` or `intake`) when evaluation fails (default `voicemail`). |
| `VOICEMAIL_STORAGE_BUCKET` | Supabase storage bucket for voicemail audio (defaults to `voicemails`). |
| `VOICEMAIL_SIGNED_URL_TTL_SECONDS` | TTL for signed voicemail URLs (default 3600 seconds). |
| `VOICEMAIL_RETENTION_DAYS` | Retention period before pruning stored recordings (default 30 days). |
| Existing Supabase, Twilio, and OpenAI keys remain required. |

### Local migration workflow

```
supabase db push
supabase db seed -f supabase/seeds/20250118_smart_call_routing_seed.sql
```

### Manual test plan

1. **Prepare data**
   - Create or reuse a test user and seed the database with one known caller: `+15555550100` labelled `client`.
   - Leave `+15555550199` absent from `callers` to represent an unknown lead.
2. **Smart auto mode**
   - From *Settings → Call routing*, choose **Smart auto** with a business-hours window that includes the current time.
   - Simulate a call from `+15555550199`. Expect the webhook to announce the AI receptionist, create a new lead/job card, and queue the confirmation SMS/email flow.
   - Call again from the known number `+15555550100`. Expect the friendly voicemail greeting, a stored recording/transcription in `call_voicemails`, and a timeline entry on the caller detail screen.
3. **Voicemail mode** – Switch to **Voicemail** mode and confirm both numbers go straight to voicemail with recordings saved.
4. **AI intake mode** – Switch to **AI intake** mode and confirm both numbers trigger the intake script and job creation.
5. **After-hours override** – Configure a schedule that excludes the current time (for example 09:00–17:00) and set the after-hours route to voicemail. With mode still on Smart auto, both callers should now reach voicemail.
6. **Manual overrides** – From the caller detail screen, set `+15555550100` to routing override **AI intake** and `label=personal`. Confirm subsequent calls follow the override regardless of global mode.
7. **Failure handling** – Temporarily block Supabase (e.g. stop the local emulator) or export `FEATURE_SMART_CALL_ROUTING=disabled` before hitting `/telephony/inbound-voice`. TwiML should default to voicemail and the call record should mark `routeFallback=true`.
8. **Observability** – Tail the server process and verify `[Telephony] Routing decision` logs include `routeDecision`, `routeReason`, `routeFallback`, and latency metadata. Forward these events to dashboards to monitor intake vs voicemail volume.

Capture these steps in your PR notes when verifying the flow.

### Automated tests

- Run `npm test` to execute the Jest suite, including smart routing webhook coverage.
- Run `npx tsc --noEmit` to perform a full TypeScript check before committing.

### Observability

- **Routing decision log** – `server.js` emits `[Telephony] Routing decision` with `route`, `reason`, `userId`, and `callerId`; alerts can key off `routeFallback=true`.
- **Evaluation errors** – look for `[Telephony] Failed to evaluate smart routing; falling back to voicemail` to spot upstream issues (Supabase/Twilio outages).
- **Voicemail persistence** – `[Telephony] Voicemail record stored for call.` confirms the transcription + metadata write succeeded.
- **Metrics** – Forward the routing decision logs (and their structured payload) to your observability stack to chart intake vs voicemail volume and fallback counts.

### Rollback plan

If the feature must be reverted, run `psql -f supabase/sql/rollback_smart_call_routing.sql` (or the equivalent via Supabase SQL editor) to drop the smart routing tables, indexes, and `calls` columns introduced by the migration. Follow with `supabase db reset` to restore seeds if continuing local development.

**Registering a device token**
```bash
curl -X POST "http://localhost:3000/me/notifications/token" \\
  -H "Authorization: Bearer <SUPABASE_JWT>" \\
  -H "Content-Type: application/json" \\
  -d '{"platform":"ios","token":"<device-token>"}'
```

**Triggering a notification for an event**
```bash
curl -X POST "http://localhost:3000/jobs/<job-id>/notify" \\
  -H "Authorization: Bearer <SUPABASE_JWT>"
```

### Voice Cloning

To enable custom receptionist voices, configure the following server environment variables:

- `ELEVENLABS_API_KEY` – ElevenLabs API key used for cloning.
- `ELEVENLABS_MODEL_ID` *(optional)* – model to use when cloning (defaults to `eleven_multilingual_v2`).
- `VOICE_PROFILE_BUCKET` *(optional)* – storage bucket for uploaded voice samples (defaults to `voice-profiles`).

The mobile app uploads recordings to Supabase storage; the server fetches the sample and initiates cloning with ElevenLabs. Status is tracked in the `voice_profiles` table.

Both endpoints return success/failure details; the notify endpoint reports the number of device sends attempted and delivered.

## Next Steps

- Voice marketplace with premium profiles and fine-grained tone sliders
- Animated koala avatar that lip-syncs during call previews
- Call simulation studio for QA before going live
- Deeper event automations (task checklists, templated follow-ups)
- Analytics for receptionist performance and conversion rates

## Support

For issues or questions, please contact the development team.
